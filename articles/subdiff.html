<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Introduction to **subdiff**: Tools for the Analysis of Passive Particle-Tracking Data • subdiff</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/readable/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Introduction to **subdiff**: Tools for the Analysis of Passive Particle-Tracking Data">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">subdiff</a>
        <span class="version label label-danger" data-toggle="tooltip" data-placement="bottom" title="Unreleased version">0.0.1.9003</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/subdiff.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/msd_conventions.html">Visual Check of Subdiffusion Estimators</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/mlysy/subdiff/" class="external-link">
    <span class="fab fa-github fa-lg"></span>

  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Introduction to <strong>subdiff</strong>: Tools for the Analysis of Passive Particle-Tracking Data</h1>
                        <h4 data-toc-skip class="author">Martin Lysy, Yun Ling</h4>
            
            <h4 data-toc-skip class="date">2024-09-06</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/mlysy/subdiff/blob/main/vignettes/subdiff.Rmd" class="external-link"><code>vignettes/subdiff.Rmd</code></a></small>
      <div class="hidden name"><code>subdiff.Rmd</code></div>

    </div>

    
    
<!-- <script type="text/x-mathjax-config"> -->
<!--   MathJax.Hub.Config({ -->
<!--       TeX: { -->
<!--      Macros: { -->
<!--          rv: ["#2_{#1},\\ldots,#2_{#3}",3,"1"] -->
<!--      } -->
<!--       } -->
<!--   }); -->
<!-- </script> -->
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>The <strong>subdiff</strong> package provides a number of utilities for analyzing subdiffusion in passive particle tracking data. Let <span class="math inline">\(\boldsymbol{X}(t) = \big(X_1(t), \ldots, X_{d}(t)\big)\)</span> denote the <span class="math inline">\(d\)</span>-dimensional position of a particle at time <span class="math inline">\(t\)</span>, where <span class="math inline">\(d\)</span> is typically between 1 and 3. In an ideal experiment, it is typically assumed that <span class="math inline">\(\boldsymbol{X}(t)\)</span> is a Continuous Stationary Increments (CSI) process, i.e., a stochastic process with mean zero and such that the distribution of <span class="math inline">\(\Delta\boldsymbol{X}(t) = \boldsymbol{X}(t+\Delta t) - \boldsymbol{X}(t)\)</span> is independent of <span class="math inline">\(t\)</span>. Under these conditions, the covariance properties of <span class="math inline">\(\boldsymbol{X}(t)\)</span> can often be deduced entirely from the particle’s mean square displacement (MSD),
<span class="math display" id="eq:msd">\[\begin{equation}
\operatorname{MSD}_{\boldsymbol{X}}(t) = \sum_{i=1}^dE\big[\big(X_i(t)-X_i(0)\big)^2\big].
\tag{1}
\end{equation}\]</span>
A widely observed phenomenon is that the MSD of microparticles diffusing in biological fluids has a power-law signature on a given timescale,
<span class="math display" id="eq:subdiff">\[\begin{equation}
  \operatorname{MSD}_{\boldsymbol{X}}(t) \sim 2dD \cdot t^\alpha, \qquad t \in (t_{\textrm{min}}, t_{\textrm{max}}).
  \tag{2}
\end{equation}\]</span>
Whereas <span class="math inline">\(\alpha = 1\)</span> corresponds to the MSD of ordinary diffusion observed in Brownian particles, the power law MSD <a href="#eq:subdiff">(2)</a> with <span class="math inline">\(\alpha \in (0,1)\)</span> is referred to as <em>subdiffusion</em>.</p>
<p>The purpose of the <strong>subdiff</strong> library is to provide simple and computationally efficient tools for modeling and estimating subdiffusion. An overview of these tools is presented below.</p>
<div class="section level3">
<h3 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h3>
<p>To install the <strong>subdiff</strong> package:</p>
<ol style="list-style-type: decimal">
<li>
<p>Install the <a href="https://CRAN.R-project.org/package=Rcpp" class="external-link"><strong>Rcpp</strong></a> package. To do this properly you will also need to install a C++ compiler. Instructions for this are available <a href="https://teuder.github.io/rcpp4everyone_en/020_install.html" class="external-link">here</a>.</p>
<p>To test that this step is done correctly, quit + restart R, then run the following command:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">Rcpp</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/Rcpp/man/evalCpp.html" class="external-link">evalCpp</a></span><span class="op">(</span><span class="st">"2 + 2"</span><span class="op">)</span></span></code></pre></div>
<p>If the output is <code>4</code> then <strong>Rcpp</strong> is installed correctly.</p>
</li>
<li><p>Install the <a href="https://CRAN.R-project.org/package=devtools" class="external-link"><strong>devtools</strong></a> package.</p></li>
<li>
<p>In an R session run the following commands:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">devtools</span><span class="fu">::</span><span class="fu">install_github</span><span class="op">(</span><span class="st">"mlysy/subdiff"</span>,</span>
<span>                         force <span class="op">=</span> <span class="cn">TRUE</span>, INSTALL_opts <span class="op">=</span> <span class="st">"--install-tests"</span><span class="op">)</span></span></code></pre></div>
</li>
<li>
<p>Once the packages are installed, to test that everything works correctly, quit + restart R then run the command:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">testthat</span><span class="fu">::</span><span class="fu"><a href="https://testthat.r-lib.org/reference/test_package.html" class="external-link">test_package</a></span><span class="op">(</span><span class="st">"subdiff"</span>, reporter <span class="op">=</span> <span class="st">"progress"</span><span class="op">)</span></span></code></pre></div>
<p>Occasionally due to random chance a few of the tests may fail. However, if everything works correctly then rerunning this a few times will eventually produce zero test failures.</p>
</li>
</ol>
</div>
<div class="section level3">
<h3 id="dataset">Dataset<a class="anchor" aria-label="anchor" href="#dataset"></a>
</h3>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># load required packages</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="https://github.com/mlysy/subdiff/" class="external-link">subdiff</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="https://github.com/mlysy/optimCheck" class="external-link">optimCheck</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va">gridExtra</span><span class="op">)</span></span>
<span><span class="co">## require(RColorBrewer)</span></span>
<span><span class="co">## require(parallel)</span></span></code></pre></div>
<p>Throughout, we’ll be using the <code>hbe</code> dataset included in the <strong>subdiff</strong> package, which consists of 76 2D trajectories of 1-micron tracer particles in 2.5 wt% mucus harvested from human bronchial epithelial (HBE) cell cultures, as detailed in <span class="citation">Hill et al. (<a href="#ref-hill.etal14">2014</a>)</span>. Each trajectory contains 1102-1785 observations recorded at a frequency of 60Hz. The full dataset is displayed in Figure <a href="#fig:hbeplot">1</a>.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">npaths</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">hbe</span><span class="op">$</span><span class="va">id</span><span class="op">)</span><span class="op">)</span> <span class="co"># number of trajectories</span></span>
<span><span class="va">n_rng</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tapply.html" class="external-link">tapply</a></span><span class="op">(</span><span class="va">hbe</span><span class="op">$</span><span class="va">id</span>, <span class="va">hbe</span><span class="op">$</span><span class="va">id</span>, <span class="va">length</span><span class="op">)</span><span class="op">)</span> <span class="co"># range of trajectory lengths</span></span>
<span><span class="va">dt</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="fl">60</span> <span class="co"># interobservation time</span></span></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># scatterplot of trajectories</span></span>
<span><span class="va">hbe</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, group <span class="op">=</span> <span class="va">id</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="va">id</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="st">"X Position ("</span><span class="op">*</span><span class="va">mu</span><span class="op">*</span><span class="va">m</span><span class="op">*</span><span class="st">")"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="st">"Y Position ("</span><span class="op">*</span><span class="va">mu</span><span class="op">*</span><span class="va">m</span><span class="op">*</span><span class="st">")"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span></span>
<span><span class="co"># histogram of trajectory lengths</span></span>
<span><span class="va">hbe</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>nobs <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span>, .groups <span class="op">=</span> <span class="st">"drop"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">nobs</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html" class="external-link">geom_histogram</a></span><span class="op">(</span>bins <span class="op">=</span> <span class="fl">30</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Number of Observations"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Counts"</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:hbeplot"></span>
<img src="subdiff_files/figure-html/hbeplot-1.png" alt="2D particle trajectories (left) and number of observation in each (right)." width="47.5%"><img src="subdiff_files/figure-html/hbeplot-2.png" alt="2D particle trajectories (left) and number of observation in each (right)." width="47.5%"><p class="caption">
Figure 1: 2D particle trajectories (left) and number of observation in each (right).
</p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="semiparametric-modeling">Semiparametric Modeling<a class="anchor" aria-label="anchor" href="#semiparametric-modeling"></a>
</h2>
<p>Let <span class="math inline">\(\boldsymbol{X}_n = \boldsymbol{X}(t_n)\)</span> denote the position of a givne particle at time <span class="math inline">\(t_n = n \cdot \Delta t\)</span>, such that the data for the entire trajectory is given by <span class="math inline">\(\boldsymbol{X}= (\boldsymbol{X}_{0},\ldots,\boldsymbol{X}_{N})\)</span>. The semi-parametric subdiffusion estimator consists of two steps:</p>
<ol style="list-style-type: decimal">
<li>
<p>Calculate the empirical MSD for each trajectory, defined as</p>
<p><span class="math display" id="eq:msdemp">\[\begin{equation}
\widehat{\operatorname{MSD}}_{\boldsymbol{X}}(t_n) = \frac 1 {(N-n+1)} \sum_{h=0}^{N-n} \Vert \boldsymbol{X}_{h+n}-\boldsymbol{X}_{h}\Vert^2.
\tag{3}
\end{equation}\]</span></p>
</li>
<li>
<p>Estimate <span class="math inline">\((\alpha,D)\)</span> by regressing <span class="math inline">\(y_n = \log \widehat{\operatorname{MSD}}_{\boldsymbol{X}}(t_n)\)</span> onto <span class="math inline">\(x_n = \log t_n\)</span>, such that</p>
<p><span class="math display">\[
\hat \alpha = \frac{\sum_{n=0}^N(y_n - \bar y)(x_n - \bar x)}{\sum_{n=0}^N(x_n - \bar x)^2}, \qquad \hat D = \frac 1 {2d} \exp(\bar y - \hat \alpha \bar x),
\]</span></p>
<p>where <span class="math inline">\(\bar x\)</span> and <span class="math inline">\(\bar y\)</span> are the samples means of <span class="math inline">\(x_n\)</span> and <span class="math inline">\(y_n\)</span>.</p>
</li>
</ol>
<p>Since particle trajectories are often contaminated with low-frequency drift, the empirical MSD is often calculated on the drift-subtracted observations,</p>
<p><span class="math display">\[
\tilde{\boldsymbol{X}}_n = \boldsymbol{X}_n - \hat{\boldsymbol{\mu}} \cdot t_n,
\]</span></p>
<p>where <span class="math inline">\(\hat{\boldsymbol{\mu}} = (\hat \mu_1, \ldots, \hat \mu_{d})\)</span> is the vector of slope terms of the linear regression of <span class="math inline">\(\boldsymbol{X}\)</span> onto <span class="math inline">\(\boldsymbol{t} = (t_{0},\ldots,t_{N})\)</span>. Morever, the empirical MSD is known to be biased at large lag times, such that only about 30-50% of the shortest lagtimes are usually kept for estimating <span class="math inline">\((\alpha,D)\)</span>.</p>
<p>Figure <a href="#fig:msdemp">2</a> displays the empirical MSD of the first 500 lags for each trajectory and the corresponding estimates of <span class="math inline">\((\alpha,D)\)</span>.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># calculate empirical MSDs</span></span>
<span><span class="va">ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">hbe</span><span class="op">$</span><span class="va">id</span><span class="op">)</span></span>
<span><span class="va">nlag</span> <span class="op">&lt;-</span> <span class="fl">500</span> <span class="co"># number of lags</span></span>
<span><span class="va">dt</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="fl">60</span> <span class="co"># interobservation time</span></span>
<span><span class="va">tseq</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="va">nlag</span><span class="op">*</span><span class="va">dt</span> <span class="co"># time sequence</span></span>
<span><span class="va">msd_hat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">ids</span>, <span class="kw">function</span><span class="op">(</span><span class="va">id</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">Xt</span> <span class="op">&lt;-</span> <span class="va">hbe</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">id</span> <span class="op">==</span> <span class="op">!</span><span class="op">!</span><span class="va">id</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>id <span class="op">=</span> <span class="va">id</span>, t <span class="op">=</span> <span class="va">tseq</span>, msd <span class="op">=</span> <span class="fu"><a href="../reference/msd_fit.html">msd_fit</a></span><span class="op">(</span>Xt <span class="op">=</span> <span class="va">Xt</span>, nlag <span class="op">=</span> <span class="va">nlag</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># calculate mean MSD and its standard error</span></span>
<span><span class="va">msd_stats</span> <span class="op">&lt;-</span> <span class="va">msd_hat</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">t</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>est <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">msd</span><span class="op">)</span>,</span>
<span>            se <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">msd</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>,</span>
<span>            .groups <span class="op">=</span> <span class="st">"drop"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># plot msd's with mean +/- 1.96 se</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">msd_stats</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># individual msd's</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">msd_hat</span>,</span>
<span>            mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">t</span>, y <span class="op">=</span> <span class="va">msd</span>, group <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span>,</span>
<span>                          color <span class="op">=</span> <span class="st">"msd"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># +/- 1.96*se confidence band</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span>mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">t</span>,</span>
<span>                            ymin <span class="op">=</span> <span class="va">est</span><span class="op">-</span><span class="fl">1.96</span><span class="op">*</span><span class="va">se</span>, ymax <span class="op">=</span> <span class="va">est</span><span class="op">+</span><span class="fl">1.96</span><span class="op">*</span><span class="va">se</span>,</span>
<span>                            color <span class="op">=</span> <span class="st">"se"</span>, fill <span class="op">=</span> <span class="st">"se"</span>, alpha <span class="op">=</span> <span class="st">"se"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># mean line</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">t</span>, y <span class="op">=</span> <span class="va">est</span>, color <span class="op">=</span> <span class="st">"est"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># set colors manually</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>msd <span class="op">=</span> <span class="st">"lightblue"</span>, est <span class="op">=</span> <span class="st">"black"</span>, se <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>msd <span class="op">=</span> <span class="cn">NA</span>, est <span class="op">=</span> <span class="cn">NA</span>, se <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_alpha_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>msd <span class="op">=</span> <span class="cn">NA</span>, est <span class="op">=</span> <span class="cn">NA</span>, se <span class="op">=</span> <span class="fl">.5</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># axes names and log-scale</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="st">"Time (s)"</span><span class="op">)</span>, trans <span class="op">=</span> <span class="st">"log10"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="st">"MSD ("</span><span class="op">*</span><span class="va">mu</span><span class="op">*</span><span class="va">m</span><span class="op">^</span><span class="fl">2</span><span class="op">*</span><span class="st">")"</span><span class="op">)</span>, trans <span class="op">=</span> <span class="st">"log10"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># remove legend</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># estimate &amp; plot subdiffusion parameters</span></span>
<span><span class="va">aD_hat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">ids</span>, <span class="kw">function</span><span class="op">(</span><span class="va">id</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">Xt</span> <span class="op">&lt;-</span> <span class="va">hbe</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">id</span> <span class="op">==</span> <span class="op">!</span><span class="op">!</span><span class="va">id</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="../reference/ls_fit.html">ls_fit</a></span><span class="op">(</span><span class="va">Xt</span>, dt <span class="op">=</span> <span class="va">dt</span>, lags <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">nlag</span>, vcov <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">aD_hat</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>  </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">logD</span><span class="op">)</span>, y <span class="op">=</span> <span class="va">alpha</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="st">"D"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="va">alpha</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_log10</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:msdemp"></span>
<img src="subdiff_files/figure-html/msdemp-1.png" alt="Empirical MSDs for the 76 trajectories (left) and corresponding estimates of $\aD$ (right)." width="47.5%"><img src="subdiff_files/figure-html/msdemp-2.png" alt="Empirical MSDs for the 76 trajectories (left) and corresponding estimates of $\aD$ (right)." width="47.5%"><p class="caption">
Figure 2: Empirical MSDs for the 76 trajectories (left) and corresponding estimates of <span class="math inline">\((\alpha,D)\)</span> (right).
</p>
</div>
</div>
<div class="section level2">
<h2 id="parametric-modeling-with-fractional-brownian-motion">Parametric Modeling with Fractional Brownian Motion<a class="anchor" aria-label="anchor" href="#parametric-modeling-with-fractional-brownian-motion"></a>
</h2>
<p>In addition to the semiparameteric “least-squares” (LS) estimator presented above, <strong>subdiff</strong> offers a range of fully-parametric subdiffusion modeling options. To illustrate, let’s start with a basic model in which the particle trajectory <span class="math inline">\(\boldsymbol{X}(t)\)</span> is given by
<span class="math display" id="eq:fbmlin">\[\begin{equation}
  \boldsymbol{X}(t) = \boldsymbol{\mu}\cdot t + \boldsymbol{\Sigma}^{1/2} \boldsymbol{B}^{(\alpha)}(t),
  \tag{4}
\end{equation}\]</span>
where:</p>
<ul>
<li><p><span class="math inline">\(\boldsymbol{\mu}= (\mu_1, \ldots, \mu_{d})\)</span> is the linear drift velocity per coordinate.</p></li>
<li><p><span class="math inline">\(\boldsymbol{\Sigma}\)</span> is a <span class="math inline">\(d\times d\)</span> symmetric positive-definite scaling matrix.</p></li>
<li>
<p><span class="math inline">\(\boldsymbol{B}^{(\alpha)}(t) = \big(B_1^{(\alpha)}(t), \ldots, B_{d}^{(\alpha)}(t)\big)\)</span> are independent and identically distributed (iid) copies of a <a href="https://en.wikipedia.org/wiki/Fractional_Brownian_motion" class="external-link">fractional Brownian motion</a> (fBM) process <span class="math inline">\(B^{(\alpha)}(t)\)</span>. That is, fBM is the only Gaussian CSI process with MSD</p>
<p><span class="math display">\[
  \operatorname{MSD}_{B^{(\alpha)}}(t) = t^\alpha.
  \]</span></p>
</li>
</ul>
<p>An attractive feature of model <a href="#eq:fbmlin">(4)</a> is that the MSD of the drift-subtracted particle trajectory <span class="math inline">\(\tilde{\boldsymbol{X}}(t) = \boldsymbol{X}(t) - t \boldsymbol{\mu}= \boldsymbol{\Sigma}^{1/2} \boldsymbol{B}^{(\alpha)}(t)\)</span> is simply given by
<span class="math display">\[
\operatorname{MSD}_{\tilde{\boldsymbol{X}}} = \operatorname{trace}(\boldsymbol{\Sigma}) \cdot  t^{\alpha},
\]</span>
such that <span class="math inline">\(D = \operatorname{trace}(\boldsymbol{\Sigma})/(2d)\)</span>. The MLE <span class="math inline">\((\hat \alpha, \log \hat D)\)</span> for <span class="math inline">\((\alpha, \log D)\)</span> and the corresponding variance estimator <span class="math inline">\(\hat V = \widehat{\operatorname{var}}(\hat \alpha, \log \hat D)\)</span> for each trajectory can be computed with <code><a href="../reference/fbm_fit.html">subdiff::fbm_fit()</a></code>:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># extract a single trajectory</span></span>
<span><span class="va">Xt</span> <span class="op">&lt;-</span> <span class="va">hbe</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">id</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># fit fbm to data</span></span>
<span><span class="va">fbm_est</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fbm_fit.html">fbm_fit</a></span><span class="op">(</span>Xt <span class="op">=</span> <span class="va">Xt</span>, dt <span class="op">=</span> <span class="va">dt</span>, drift <span class="op">=</span> <span class="st">"linear"</span><span class="op">)</span></span>
<span><span class="va">fbm_est</span></span>
<span><span class="co">#&gt; $coef</span></span>
<span><span class="co">#&gt;      alpha       logD </span></span>
<span><span class="co">#&gt;  0.7432851 -3.4418462 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $vcov</span></span>
<span><span class="co">#&gt;              alpha        logD</span></span>
<span><span class="co">#&gt; alpha 0.0005982074 0.002275383</span></span>
<span><span class="co">#&gt; logD  0.0022753833 0.009387893</span></span></code></pre></div>
<p>But what about estimates of the full set of parameters, <span class="math inline">\(\boldsymbol{\theta}= (\alpha, \boldsymbol{\mu}, \boldsymbol{\Sigma})\)</span>? We’ll return to this point <a href="#deltamethod">below</a>.</p>
</div>
<div class="section level2">
<h2 id="parametric-modeling-in-the-presense-of-noise">Parametric Modeling in the Presense of Noise<a class="anchor" aria-label="anchor" href="#parametric-modeling-in-the-presense-of-noise"></a>
</h2>
<p>Figure <a href="#fig:msdnoise">3</a> displays MSD estimates for the trajectory <code>Xt</code> above, using the (drift-subtracted) empirical estimator <a href="#eq:msdemp">(3)</a> and that of the fitted fBM model.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tmax</span> <span class="op">&lt;-</span> <span class="fl">10</span> <span class="co"># seconds</span></span>
<span><span class="va">Nmax</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="va">tmax</span><span class="op">/</span><span class="va">dt</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>t <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">Nmax</span> <span class="op">*</span> <span class="va">dt</span>,</span>
<span>       Empirical <span class="op">=</span> <span class="fu"><a href="../reference/msd_fit.html">msd_fit</a></span><span class="op">(</span><span class="va">Xt</span>, nlag <span class="op">=</span> <span class="va">Nmax</span><span class="op">)</span>,</span>
<span>       fBM <span class="op">=</span> <span class="fl">4</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">fbm_est</span><span class="op">$</span><span class="va">coef</span><span class="op">[</span><span class="st">"logD"</span><span class="op">]</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">Nmax</span> <span class="op">*</span> <span class="va">dt</span><span class="op">)</span><span class="op">^</span><span class="va">fbm_est</span><span class="op">$</span><span class="va">coef</span><span class="op">[</span><span class="st">"alpha"</span><span class="op">]</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="va">Empirical</span><span class="op">:</span><span class="va">fBM</span>, names_to <span class="op">=</span> <span class="st">"MSD Type"</span>, values_to <span class="op">=</span> <span class="st">"msd"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">t</span>, y <span class="op">=</span> <span class="va">msd</span>, group <span class="op">=</span> <span class="va">`MSD Type`</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>col <span class="op">=</span> <span class="va">`MSD Type`</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="st">"Time (s)"</span><span class="op">)</span>, trans <span class="op">=</span> <span class="st">"log10"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="st">"MSD ("</span><span class="op">*</span><span class="va">mu</span><span class="op">*</span><span class="va">m</span><span class="op">^</span><span class="fl">2</span><span class="op">*</span><span class="st">")"</span><span class="op">)</span>, trans <span class="op">=</span> <span class="st">"log10"</span><span class="op">)</span>  </span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:msdnoise"></span>
<img src="subdiff_files/figure-html/msdnoise-1.png" alt="Empirical and fBM-fitted MSDs." width="100%"><p class="caption">
Figure 3: Empirical and fBM-fitted MSDs.
</p>
</div>
<p>Figure <a href="#fig:msdnoise">3</a> shows that the empirical MSD has an inflection point around 0.05 seconds, which we also see in the average MSD (over all 76 trajectories) in Figure <a href="#fig:msdemp">2</a>. This is not a feature of the underlying particle motion, but rather of various sources of experimental noise due to e.g.: mechanical vibrations of the instrumental setup; particle displacement while the camera shutter is open; noisy estimation of true position from the pixelated microscopy image; and error-prone tracking of particle positions when they are out of the camera focal plane.</p>
<p>The <strong>subdiff</strong> package currently provides two parametric models to account for the high-frequency “localization errors” described above. The first relies on a physical characterization of the localization errors given in the seminal paper of <span class="citation">Savin and Doyle (<a href="#ref-savin.doyle05">2005</a>)</span>. For a one dimensional particle trajectory <span class="math inline">\(X(t)\)</span>, let <span class="math inline">\(Y_n\)</span> denote the measured position at time <span class="math inline">\(t_n = n \cdot \Delta t\)</span>. The Savin-Doyle model for <span class="math inline">\(Y_n\)</span> is</p>
<p><span class="math display" id="eq:fsd">\[\begin{equation}
Y_n = \frac 1 \tau \int_0^{\tau} X(t_n - s) \mathop{}\!\mathrm{d}s + \varepsilon_n,
\tag{5}
\end{equation}\]</span></p>
<p>where <span class="math inline">\(\varepsilon_n \stackrel{\mathrm{iid}}{\sim}\mathcal{N}(0, \sigma^2)\)</span> represents the “static” noise due to measurement error in recording the position of the particle at a given time, and the integral term represents the “dynamic” noise due to movement of the particle during the camera exposure time <span class="math inline">\(0 &lt; \tau &lt; \Delta t\)</span>.</p>
<p>The second parametric noise model provided by <strong>subdiff</strong> is that of <span class="citation">Ling et al. (<a href="#ref-ling.etal19">2022</a>)</span>. Rather than attempting to characterize the complex physics of the localization errors, the strategy here is to provide sufficient modeling flexibility to capture any high-frequency errors exhibited by the experimental data. This is achieved via the general family of <span class="math inline">\(\operatorname{ARMA}(p, q)\)</span> models, such that the measurements <span class="math inline">\(Y_n\)</span> related to the true positions <span class="math inline">\(X_n = X(t_n)\)</span> via</p>
<p><span class="math display">\[\begin{equation}
Y_n = \sum_{i=1}^p \theta_i Y_{n-i} + \sum_{j=0}^q \rho_j X_{n-j},
\end{equation}\]</span></p>
<p>where we have the parameter restriction <span class="math inline">\(\rho_0 = 1 - \sum_{i=1}^p \theta_i - \sum_{j=1}^q \rho_j\)</span>. To illustrate the difference between the two noise models, suppose that <span class="math inline">\(X(t) = D \cdot B^{(\alpha)}(t)\)</span> is an fBM process with <span class="math inline">\(\alpha = 0.8\)</span> and <span class="math inline">\(D = 1\)</span>. The MSD of the corresponding fBM-driven Savin-Doyle model <a href="#eq:fsd">(5)</a>, which we call fSD, is plotted in Figure <a href="#fig:fsdvsfma">4</a>(a), with different values of the noise parameters. Here, we parametrize the static error by the signal-to-noise ratio, <span class="math inline">\(\mathrm{SNR}= \operatorname{var}(X(\Delta t))/\sigma^2 = D \Delta t^\alpha / \sigma^2\)</span>. Figure <a href="#fig:fsdvsfma">4</a>(b) displays the MSD of the simplest fBM-driven <span class="math inline">\(\operatorname{ARMA}(p,q)\)</span> model, a purely moving-average model with <span class="math inline">\(p = 0\)</span> and <span class="math inline">\(q = 1\)</span>:</p>
<p><span class="math display">\[
Y_n = (1-\rho) X_n + \rho X_{n-1}.
\]</span></p>
<p>We call this model fMA. Figure <a href="#fig:fsdvsfma">4</a>(b) plots its MSD over the valid parameter range <span class="math inline">\(-1 \le \rho \le 0.5\)</span> (see Appendix for code).</p>
<div class="figure">
<span style="display:block;" id="fig:fsdvsfma"></span>
<img src="subdiff_files/figure-html/fsdvsfma-1.png" alt="MSDs of the fSD and fMA models with different noise parameter values." width="100%"><p class="caption">
Figure 4: MSDs of the fSD and fMA models with different noise parameter values.
</p>
</div>
<p>As we can see, the fSD model is more expressive for localization errors which inflate the MSD at shorter timescales, while fMA is more expressive errors which suppress it. The following code fits the fSD and fMA models, and compare their estimates to fBM without error correction.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># fit fsd to data</span></span>
<span><span class="va">fsd_est</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fsd_fit.html">fsd_fit</a></span><span class="op">(</span>Xt <span class="op">=</span> <span class="va">Xt</span>, dt <span class="op">=</span> <span class="va">dt</span>, drift <span class="op">=</span> <span class="st">"linear"</span><span class="op">)</span></span>
<span><span class="co"># fit fma to data</span></span>
<span><span class="va">fma_est</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/farma_fit.html">farma_fit</a></span><span class="op">(</span>Xt <span class="op">=</span> <span class="va">Xt</span>, dt <span class="op">=</span> <span class="va">dt</span>, order <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, drift <span class="op">=</span> <span class="st">"linear"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># display nicely</span></span>
<span></span>
<span><span class="co"># display estimates and standard errors for (alpha, logD) </span></span>
<span><span class="va">to_summary</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">est</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">coef</span> <span class="op">&lt;-</span> <span class="va">est</span><span class="op">$</span><span class="va">coef</span></span>
<span>  <span class="va">se</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">est</span><span class="op">$</span><span class="va">vcov</span><span class="op">)</span><span class="op">)</span>, nm <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">coef</span><span class="op">)</span>, <span class="st">"_se"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">coef</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">se</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">coef</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="va">se</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">disp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span>fbm <span class="op">=</span> <span class="fu">to_summary</span><span class="op">(</span><span class="va">fbm_est</span><span class="op">)</span>,</span>
<span>              fsd <span class="op">=</span> <span class="fu">to_summary</span><span class="op">(</span><span class="va">fsd_est</span><span class="op">)</span>,</span>
<span>              fma <span class="op">=</span> <span class="fu">to_summary</span><span class="op">(</span><span class="va">fma_est</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">signif</a></span><span class="op">(</span><span class="va">disp</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#&gt;     alpha alpha_se logD logD_se</span></span>
<span><span class="co">#&gt; fbm  0.74    0.024 -3.4   0.097</span></span>
<span><span class="co">#&gt; fsd  0.55    0.048 -3.8   0.096</span></span>
<span><span class="co">#&gt; fma  0.59    0.037 -3.7   0.099</span></span></code></pre></div>
<p>These numbers indicate that the <span class="math inline">\((\alpha,D)\)</span> estimates with noise correction are more than two standard errors away from those of pure fBM.</p>
</div>
<div class="section level2">
<h2 id="user-defined-models">User-Defined Models<a class="anchor" aria-label="anchor" href="#user-defined-models"></a>
</h2>
<p>The <strong>subdiff</strong> tools can be applied to a large family of user-defined models. These are based on the location-scale modeling framework of <span class="citation">Lysy et al. (<a href="#ref-lysy.etal16">2016</a>)</span>, whereby the particle trajectory <span class="math inline">\(\boldsymbol{X}(t)\)</span> is given by
<span class="math display" id="eq:locscale">\[\begin{equation}
  \boldsymbol{X}(t) = \boldsymbol{R}(t \mid \boldsymbol{\phi})' \boldsymbol{\mu}+ \boldsymbol{\Sigma}^{1/2} \boldsymbol{Z}(t),
  \tag{6}
\end{equation}\]</span>
where:</p>
<ul>
<li>
<p><span class="math inline">\(\boldsymbol{Z}(t) = \big(Z_1(t), \ldots, Z_{d}(t)\big)\)</span> are independent and identically distributed (iid) copies of a CSI process <span class="math inline">\(Z(t)\)</span> having MSD</p>
<p><span class="math display">\[
  \operatorname{MSD}_Z(t) = \eta(t \mid \boldsymbol{\phi}).
  \]</span></p>
</li>
<li><p><span class="math inline">\(\boldsymbol{\Sigma}\)</span> is a <span class="math inline">\(d\times d\)</span> symmetric positive-definite scaling matrix.</p></li>
<li><p><span class="math inline">\(\boldsymbol{R}(t \mid \boldsymbol{\phi}) = \big( R_1(t \mid \boldsymbol{\phi}), \ldots, R_{k}(t \mid \boldsymbol{\phi}) \big)\)</span> is a set of <span class="math inline">\(k\)</span> drift basis functions. Typically it will be linear or quadratic, corresponding to <span class="math inline">\(\boldsymbol{R}(t) = t\)</span> and <span class="math inline">\(\boldsymbol{R}(t) = (t, t^2)\)</span> with <span class="math inline">\(k= 1\)</span> and <span class="math inline">\(k= 2\)</span>, respectively. However, <strong>subdiff</strong> allows for an arbitrary number of basis functions possibly dependent on the “kernel” parameters <span class="math inline">\(\boldsymbol{\phi}\)</span>.</p></li>
<li><p><span class="math inline">\(\boldsymbol{\mu}\)</span> is <span class="math inline">\(k\times d\)</span> matrix of drift coefficients. For linear drift, <span class="math inline">\(\boldsymbol{\mu}= (\mu _{1},\ldots,\mu _{d})\)</span> correspond to per-coordinate drift velocities.</p></li>
</ul>
<p>An attractive feature of model <a href="#eq:locscale">(6)</a> is that the MSD of the drift-subtracted particle trajectory <span class="math inline">\(\tilde{\boldsymbol{X}}(t) = \boldsymbol{X}(t) - \boldsymbol{R}(t)' \boldsymbol{\mu}\)</span> has the simple formula</p>
<p><span class="math display">\[
\operatorname{MSD}_{\tilde{\boldsymbol{X}}} = \operatorname{trace}(\boldsymbol{\Sigma}) \cdot  \eta(t \mid \boldsymbol{\phi}).
\]</span></p>
<p>Another appealing property of this model is that its parameters <span class="math inline">\(\boldsymbol{\theta}= (\boldsymbol{\phi}, \boldsymbol{\mu}, \boldsymbol{\Sigma})\)</span> can be estimated from discrete observations <span class="math inline">\(\boldsymbol{X}= (\boldsymbol{X}_{0},\ldots,\boldsymbol{X}_{N})\)</span> in a computationally efficient manner <span class="citation">(<a href="#ref-ling.lysy20">Ling and Lysy 2020</a>)</span>.</p>
<div class="section level3">
<h3 id="example-brownian-motion-in-a-jeffreys-fluid">Example: Brownian Motion in a Jeffreys Fluid<a class="anchor" aria-label="anchor" href="#example-brownian-motion-in-a-jeffreys-fluid"></a>
</h3>
<p>Consider a particle of radius <span class="math inline">\(r\)</span> in a Jeffreys fluid described by viscosity parameters <span class="math inline">\(\eta_1\)</span> and <span class="math inline">\(\eta_2\)</span> and elastic modulus <span class="math inline">\(\Gamma\)</span>. The MSD of the drift-subtracted particle trajectory <span class="math inline">\(\tilde{\boldsymbol{X}}(t)\)</span> is given by <span class="citation">(<a href="#ref-raikher.rusakov10">Raikher and Rusakov 2010</a>)</span></p>
<p><span class="math display" id="eq:jfsmsd">\[\begin{equation}
\operatorname{MSD}_{\tilde{\boldsymbol{X}}}(t) = \frac{2dk_{\mathrm{B}}T}{\xi_V(1+q)} \times \left\{t + \frac{q}{1+q} \tau_M \left[1 - \exp\left(-\frac{(1+q)t}{\tau_M}\right)\right]\right\},
\tag{7}
\end{equation}\]</span></p>
<p>where <span class="math inline">\(q = \eta_1/\eta_2\)</span>, <span class="math inline">\(\tau_M = (\eta_1 + \eta_2)/\Gamma\)</span>, <span class="math inline">\(\xi_V = 6\pi r \cdot \eta_1\eta_2/(\eta_1 + \eta_2)\)</span>, and <span class="math inline">\(T\)</span> and <span class="math inline">\(r\)</span> are the temperature of the system and radius of the particle, respectively. A more natural parametrization is</p>
<p><span class="math display">\[
\operatorname{MSD}_{\tilde{\boldsymbol{X}}}(t) = 2d\sigma^2 \left\{t + \alpha \left[1 - e^{-t/\tau}\right]\right\},
\]</span></p>
<p>where <span class="math inline">\(\tau = \tau_M/(1+q) = \eta_2/\Gamma\)</span>, <span class="math inline">\(\alpha = \tau q = \eta_1/\Gamma\)</span>, and <span class="math inline">\(\sigma^2 = k_{\mathrm{B}}T/ (\xi_V(1+q)) = k_{\mathrm{B}}T/ (6\pi r \eta_1)\)</span>. In the formulation of the location-scale model <a href="#eq:locscale">(6)</a>, the CSI process <span class="math inline">\(Z(t)\)</span> underlying the particle trajectory <span class="math inline">\(\boldsymbol{X}(t)\)</span> has MSD</p>
<p><span class="math display">\[
\eta(t \mid \boldsymbol{\phi}) = \operatorname{MSD}_Z(t) = \left\{t + \alpha \left[1 - e^{-t/\tau}\right]\right\}
\]</span></p>
<p>with <span class="math inline">\(\boldsymbol{\phi}= (\alpha, \tau)\)</span>, and the MSD scale factor is <span class="math inline">\(\sigma^2 = \operatorname{trace}(\boldsymbol{\Sigma})/(2d)\)</span>.</p>
</div>
<div class="section level3">
<h3 id="creating-the-jeffreys-model-class">Creating the Jeffreys Model Class<a class="anchor" aria-label="anchor" href="#creating-the-jeffreys-model-class"></a>
</h3>
<p>In order to fit the Jeffreys model <a href="#eq:jfsmsd">(7)</a> to trajectory data, we will create a class <code>jfs_model</code> which will derive from the base class <code>csi_model</code> used to represent the general location-scale model <a href="#eq:locscale">(6)</a>. In order to do this, we will need the following ingredients:</p>
<ul>
<li>
<p>The increment autocorrelation function</p>
<p><span class="math display">\[
  \operatorname{ACF}_{\Delta Z}(h) = \operatorname{cov}(\Delta Z_n, \Delta Z_{n+h}).
  \]</span></p>
<p>This must be supplied as a function with arguments <span class="math inline">\((\boldsymbol{\phi}, \Delta t, N)\)</span> and return the vector <span class="math inline">\(\big(\operatorname{ACF}_{\Delta Z}(0), \ldots, \operatorname{ACF}_{\Delta Z}(N-1)\big)\)</span>. Note that <span class="math inline">\(\operatorname{MSD}_{Z}(t)\)</span> can be converted to <span class="math inline">\(\operatorname{ACF}_{\Delta Z}(h)\)</span> via the function <code><a href="https://rdrr.io/pkg/SuperGauss/man/msd2acf.html" class="external-link">SuperGauss::msd2acf()</a></code>, as we do in the function <code>jfs_acf()</code> below.</p>
</li>
<li><p>Functions to convert back and forth between the kernel parameters in the “inferential” basis, <span class="math inline">\(\boldsymbol{\phi}\)</span>, and these parameters in a “computational basis”, <span class="math inline">\(\boldsymbol{\psi}\)</span>. That is, <span class="math inline">\(\boldsymbol{\psi}\)</span> should have the same dimension as <span class="math inline">\(\boldsymbol{\phi}\)</span> but have no constraints. For the Jeffreys model, since <span class="math inline">\(\alpha, \tau &gt; 0\)</span>, a natural choice of computational basis is <span class="math inline">\(\boldsymbol{\psi}= (\log \alpha, \log \tau)\)</span>.</p></li>
<li><p>Specification of the drift basis functions <span class="math inline">\(\boldsymbol{R}(t \mid \boldsymbol{\phi})\)</span>. This is done automatically in the case of linear, quadratic, or no drift, so we’ll skip this here.</p></li>
<li><p>A character vector of the names of the elements of <span class="math inline">\(\boldsymbol{\phi}\)</span> for display purposes.</p></li>
</ul>
<p>The following code block defines the <code>jfs_model</code> class. This is done with the <a href="https://r6.r-lib.org/index.html" class="external-link">R6</a> class mechanism, of which a basic understanding is assumed. More information about the base class for location-scale models can be obtained from the package documentation: <code><a href="../reference/csi_model.html">?csi_model</a></code>.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Calculate the ACF of the Jeffreys model.</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @param alpha Scale parameter.</span></span>
<span><span class="co">#' @param tau Decorrelation time.</span></span>
<span><span class="co">#' @param dt Interobservation time.</span></span>
<span><span class="co">#' @param N Number of ACF lags to return.</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @return An ACF vector of length `N`.</span></span>
<span><span class="va">jfs_acf</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">alpha</span>, <span class="va">tau</span>, <span class="va">dt</span>, <span class="va">N</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">t</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">N</span><span class="op">)</span><span class="op">*</span><span class="va">dt</span> <span class="co"># time vector</span></span>
<span>  <span class="va">msd</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">t</span> <span class="op">+</span> <span class="va">alpha</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">t</span><span class="op">/</span><span class="va">tau</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu">SuperGauss</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/SuperGauss/man/msd2acf.html" class="external-link">msd2acf</a></span><span class="op">(</span><span class="va">msd</span><span class="op">)</span> <span class="co"># convert msd to acf</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">jfs_model</span> <span class="op">&lt;-</span> <span class="fu">R6</span><span class="fu">::</span><span class="kw"><a href="https://r6.r-lib.org/reference/R6Class.html" class="external-link">R6Class</a></span><span class="op">(</span></span>
<span>  classname <span class="op">=</span> <span class="st">"jfs_model"</span>,</span>
<span>  inherit <span class="op">=</span> <span class="fu">subdiff</span><span class="fu">::</span><span class="va"><a href="../reference/csi_model.html">csi_model</a></span>,</span>
<span></span>
<span>  public <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="co"># Kernel parameter names in the inferential basis.</span></span>
<span>    phi_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"alpha"</span>, <span class="st">"tau"</span><span class="op">)</span>,</span>
<span></span>
<span>    <span class="co"># Autocorrelation function.</span></span>
<span>    acf <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">phi</span>, <span class="va">dt</span>, <span class="va">N</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu">jfs_acf</span><span class="op">(</span>alpha <span class="op">=</span> <span class="va">phi</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, tau <span class="op">=</span> <span class="va">phi</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, dt <span class="op">=</span> <span class="va">dt</span>, N <span class="op">=</span> <span class="va">N</span><span class="op">)</span></span>
<span>    <span class="op">}</span>,</span>
<span></span>
<span>    <span class="co"># Transform kernel parameters from inferential to computational basis.</span></span>
<span>    trans <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">phi</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">psi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">phi</span><span class="op">)</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">psi</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">private</span><span class="op">$</span><span class="va">psi_names</span> <span class="co"># these are determined automatically.</span></span>
<span>      <span class="va">psi</span></span>
<span>    <span class="op">}</span>,</span>
<span></span>
<span>    <span class="co"># Transform kernel parameters from computational to inferential basis.</span></span>
<span>    itrans <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">psi</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">phi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">psi</span><span class="op">)</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">phi</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">self</span><span class="op">$</span><span class="va">phi_names</span></span>
<span>      <span class="va">phi</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="simulation">Simulation<a class="anchor" aria-label="anchor" href="#simulation"></a>
</h3>
<!-- In @raikher.rusakov10, the Jeffreys model \@ref(eq:jfsmsd) is calibrated to particles of radius $r = NA\, \mathrm{\mu m}$ in a solution of cetyltrimethyl ammonium bromide $[\mathrm{CTAB}] = 1\, \mathrm{g}\, \mathrm{cm}^{-3}$ and potassium bromide $[\mathrm{KBr}] = 2\, \mathrm{M}$ at temperature $T = 298\, \mathrm{K}$.  The fitted parameters are $\tau_M = 2.1\, \mathrm{s}$, $q = 46$, and $\xi_V = 1.4\times 10^{-7}\, \mathrm{kg/s}$. -->
<p>The following code shows how to simulate the trajectory of a particle from the Jeffreys model with parameters <span class="math inline">\(\tau_M = 2.1\, \mathrm{s}\)</span>, <span class="math inline">\(q = 46\)</span>, and <span class="math inline">\(\xi_V = 1.4\times 10^{-7}\, \mathrm{kg/s}\)</span> and temperature <span class="math inline">\(T = 298\, \mathrm{K}\)</span>. The 2D trajectory is generated with zero drift <span class="math inline">\(\boldsymbol{R}(t \mid \boldsymbol{\phi}) = 0\)</span>, and scale factor <span class="math inline">\(\boldsymbol{\Sigma}= \left[\begin{smallmatrix} \sigma^2 &amp; 0 \\ 0 &amp; \sigma^2 \end{smallmatrix} \right]\)</span>. Figure <a href="#fig:jfssim">5</a> compares the empirical MSD for the simulated trajectory to the theoretical MSD.</p>

<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">kB</span> <span class="op">&lt;-</span> <span class="fl">1.38064852e-23</span> <span class="co"># Boltzmann constant</span></span>
<span></span>
<span><span class="co"># simulation parameters</span></span>
<span><span class="va">tau_M</span> <span class="op">&lt;-</span> <span class="fl">2.1</span> <span class="co"># seconds</span></span>
<span><span class="va">q</span> <span class="op">&lt;-</span> <span class="fl">4.6e1</span> <span class="co"># unitless</span></span>
<span><span class="va">xi_V</span> <span class="op">&lt;-</span> <span class="fl">1.4e-07</span> <span class="co"># kg/s</span></span>
<span><span class="va">Temp</span> <span class="op">&lt;-</span> <span class="fl">298</span> <span class="co"># temperature of the system (Kelvin)</span></span>
<span></span>
<span><span class="va">dt</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="fl">60</span> <span class="co"># interobservation time</span></span>
<span><span class="va">N</span> <span class="op">&lt;-</span> <span class="fl">1800</span> <span class="co"># number of observations</span></span>
<span><span class="va">ndim</span> <span class="op">&lt;-</span> <span class="fl">2</span> <span class="co"># number of dimensions</span></span>
<span></span>
<span><span class="co"># increment autocorrelation</span></span>
<span><span class="va">tau</span> <span class="op">&lt;-</span> <span class="va">tau_M</span><span class="op">/</span><span class="op">(</span><span class="fl">1</span><span class="op">+</span><span class="va">q</span><span class="op">)</span></span>
<span><span class="va">alpha</span> <span class="op">&lt;-</span> <span class="va">tau</span> <span class="op">*</span> <span class="va">q</span></span>
<span><span class="va">acf</span> <span class="op">&lt;-</span> <span class="fu">jfs_acf</span><span class="op">(</span>alpha <span class="op">=</span> <span class="va">alpha</span>, tau <span class="op">=</span> <span class="va">tau</span>, dt <span class="op">=</span> <span class="va">dt</span>, N <span class="op">=</span> <span class="va">N</span><span class="op">)</span></span>
<span><span class="co"># increment drift matrix: in this case zero drift</span></span>
<span><span class="va">drift</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">N</span>, <span class="va">ndim</span><span class="op">)</span></span>
<span><span class="co"># scale matrix (micron^2)</span></span>
<span><span class="va">sigma2</span> <span class="op">&lt;-</span> <span class="fl">1e12</span> <span class="op">*</span> <span class="va">kB</span><span class="op">*</span><span class="va">Temp</span> <span class="op">/</span> <span class="op">(</span><span class="va">xi_V</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span><span class="op">+</span><span class="va">q</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">Sigma</span> <span class="op">&lt;-</span> <span class="va">sigma2</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">ndim</span><span class="op">)</span></span>
<span><span class="co"># position at time t = 0</span></span>
<span><span class="va">X0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">ndim</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># generate data</span></span>
<span><span class="va">Xt</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/csi_sim.html">csi_sim</a></span><span class="op">(</span>drift <span class="op">=</span> <span class="va">drift</span>, acf <span class="op">=</span> <span class="va">acf</span>,</span>
<span>              Sigma <span class="op">=</span> <span class="va">Sigma</span>, X0 <span class="op">=</span> <span class="va">X0</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># plot empirical and theoretical MSD</span></span>
<span><span class="va">tmax</span> <span class="op">&lt;-</span> <span class="fl">10</span> <span class="co"># maximum time to plot</span></span>
<span><span class="va">nmax</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="va">tmax</span><span class="op">/</span><span class="va">dt</span><span class="op">)</span> <span class="co"># corresponding MSD lag number</span></span>
<span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>  Time <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">nmax</span> <span class="op">*</span> <span class="va">dt</span>, <span class="co"># time sequence</span></span>
<span>  Theoretical <span class="op">=</span> <span class="va">ndim</span><span class="op">*</span><span class="va">sigma2</span> <span class="op">*</span> <span class="fu">SuperGauss</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/SuperGauss/man/acf2msd.html" class="external-link">acf2msd</a></span><span class="op">(</span><span class="va">acf</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">nmax</span><span class="op">]</span><span class="op">)</span>, <span class="co"># theoretical msd</span></span>
<span>  Empirical <span class="op">=</span> <span class="fu"><a href="../reference/msd_fit.html">msd_fit</a></span><span class="op">(</span><span class="va">Xt</span>, nlag <span class="op">=</span> <span class="va">nmax</span><span class="op">)</span> <span class="co"># empirical msd</span></span>
<span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="va">Theoretical</span><span class="op">:</span><span class="va">Empirical</span>, names_to <span class="op">=</span> <span class="st">"MSD Type"</span>,</span>
<span>               values_to <span class="op">=</span> <span class="st">"MSD"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>`MSD Type` <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">`MSD Type`</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Time</span>, y <span class="op">=</span> <span class="va">MSD</span>, group <span class="op">=</span> <span class="va">`MSD Type`</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="va">`MSD Type`</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_log10</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_log10</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="st">"Time "</span><span class="op">*</span><span class="op">(</span><span class="va">s</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="st">"MSD "</span><span class="op">*</span><span class="op">(</span><span class="va">mu</span><span class="op">*</span><span class="va">m</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:jfssim"></span>
<img src="subdiff_files/figure-html/jfssim-1.png" alt="Empirical and theoretical MSD for the Jeffreys model with parameters \(\tau_M = 2.1\, \mathrm{s}\), \(q = 46\), and \(\xi_V = 1.4\times 10^{-7}\, \mathrm{kg/s}\) and temperature \(T = 298\, \mathrm{K}\)."><p class="caption">
Figure 5: Empirical and theoretical MSD for the Jeffreys model with parameters <span class="math inline">\(\tau_M = 2.1\, \mathrm{s}\)</span>, <span class="math inline">\(q = 46\)</span>, and <span class="math inline">\(\xi_V = 1.4\times 10^{-7}\, \mathrm{kg/s}\)</span> and temperature <span class="math inline">\(T = 298\, \mathrm{K}\)</span>.
</p>
</div>
</div>
<div class="section level3">
<h3 id="parameter-estimation">Parameter Estimation<a class="anchor" aria-label="anchor" href="#parameter-estimation"></a>
</h3>
<p>The <code>jfs_model</code> class inherits from the base class <code>csi_model</code>, which contains a number of methods to assist with parameter estimation. In the following example, we’ll use these to calculate the MLE of the Jeffreys fluid parameters <span class="math inline">\(\boldsymbol{\zeta}= (\eta_1, \eta_2, \Gamma)\)</span> along with their standard errors. This proceeds in several steps:</p>
<div class="section level4">
<h4 id="step-1-profile-likelihood">Step 1: Profile Likelihood<a class="anchor" aria-label="anchor" href="#step-1-profile-likelihood"></a>
</h4>
<p>The first step is to calculate the MLE of the kernel parameters <span class="math inline">\(\boldsymbol{\phi}= (\alpha, \tau)\)</span>. Let <span class="math inline">\(\ell(\boldsymbol{\theta}\mid \boldsymbol{X}) = \ell(\boldsymbol{\phi}, \boldsymbol{\mu}, \boldsymbol{\Sigma}\mid \boldsymbol{X})\)</span> denote the loglikelihood function for the complete set of parameters. As noted in <span class="citation">Ling et al. (<a href="#ref-ling.etal19">2022</a>)</span>,</p>
<p><span class="math display">\[
(\hat{\boldsymbol{\mu}}_{\boldsymbol{\phi}}, \hat{\boldsymbol{\Sigma}}_{\boldsymbol{\phi}}) = \operatorname{arg\,max}_{(\boldsymbol{\mu}, \boldsymbol{\Sigma})} \ell(\boldsymbol{\phi}, \boldsymbol{\mu}, \boldsymbol{\Sigma}\mid \boldsymbol{X})
\]</span></p>
<p>is available in closed-form, from which we may calculate the so-called <a href="https://en.wikipedia.org/wiki/Likelihood_function#Profile_likelihood" class="external-link">profile likelihood</a> function</p>
<p><span class="math display" id="eq:llprof">\[\begin{equation}
\begin{aligned}
\ell_{\textrm{prof}}(\boldsymbol{\phi}\mid \boldsymbol{X}) &amp;= \max_{\boldsymbol{\mu}, \boldsymbol{\Sigma}} \ell(\boldsymbol{\phi}, \boldsymbol{\mu}, \boldsymbol{\Sigma}\mid \boldsymbol{X}) \\
&amp; = \ell(\boldsymbol{\phi}, \hat{\boldsymbol{\mu}}_{\boldsymbol{\phi}}, \hat{\boldsymbol{\Sigma}}_{\boldsymbol{\phi}} \mid \boldsymbol{X}).  
\end{aligned}
\tag{8}
\end{equation}\]</span></p>
<p>It follows that if <span class="math inline">\(\hat{\boldsymbol{\phi}} = \operatorname{arg\,max}_{\boldsymbol{\phi}} \ell_{\textrm{prof}}(\boldsymbol{\phi}\mid \boldsymbol{X})\)</span>, then the MLE of <span class="math inline">\(\boldsymbol{\theta}= (\boldsymbol{\phi}, \boldsymbol{\mu}, \boldsymbol{\Sigma})\)</span> is given by</p>
<p><span class="math display">\[
\hat{\boldsymbol{\theta}} = (\hat{\boldsymbol{\phi}}, \hat{\boldsymbol{\mu}}_{\hat{\boldsymbol{\phi}}}, \hat{\boldsymbol{\Sigma}}_{\hat{\boldsymbol{\phi}}}).
\]</span></p>
<p>The upshot of this technique is that <span class="math inline">\(\hat{\boldsymbol{\theta}}\)</span> can be obtained by maximizing <span class="math inline">\(\ell_{\textrm{prof}}(\boldsymbol{\phi}\mid \boldsymbol{X})\)</span> rather than <span class="math inline">\(\ell(\boldsymbol{\theta}\mid \boldsymbol{X})\)</span>. The former is a lower-dimensional optimization problem, and thus more computationally efficient.</p>
<p>The following code shows how to calculate <span class="math inline">\(\hat{\boldsymbol{\theta}}\)</span>. Note that the optimization of the profile likelihood <a href="#eq:llprof">(8)</a> is done with respect to <span class="math inline">\(\boldsymbol{\psi}\)</span>, the kernel parameters in the computational basis. We’ll use the function <code><a href="https://rdrr.io/r/stats/optim.html" class="external-link">stats::optim()</a></code> for this.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># construct the model object</span></span>
<span><span class="va">mod</span> <span class="op">&lt;-</span> <span class="va">jfs_model</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>Xt <span class="op">=</span> <span class="va">Xt</span>, dt <span class="op">=</span> <span class="va">dt</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># minimize the negative profile likelihood.</span></span>
<span><span class="va">opt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/optim.html" class="external-link">optim</a></span><span class="op">(</span>fn <span class="op">=</span> <span class="va">mod</span><span class="op">$</span><span class="va">nlp</span>, <span class="co"># negative profile likelihood</span></span>
<span>             par <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="co"># initial value of psi</span></span>
<span></span>
<span><span class="co"># mle of psi</span></span>
<span><span class="va">psi_hat</span> <span class="op">&lt;-</span> <span class="va">opt</span><span class="op">$</span><span class="va">par</span></span>
<span><span class="va">psi_hat</span></span>
<span><span class="co">#&gt; [1]  0.4958942 -3.2063559</span></span></code></pre></div>
<p>Before going further, it is sometimes useful to check whether <code><a href="https://rdrr.io/r/stats/optim.html" class="external-link">stats::optim()</a></code> has indeed converged. One way to do this is by examining the convergence flag:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">opt</span><span class="op">$</span><span class="va">convergence</span></span>
<span><span class="co">#&gt; [1] 0</span></span></code></pre></div>
<p>A value of zero means <code><a href="https://rdrr.io/r/stats/optim.html" class="external-link">stats::optim()</a></code> thinks it has converged. Any other value means it hasn’t converged (details in the function documentation). However, the convergence metric used by <code><a href="https://rdrr.io/r/stats/optim.html" class="external-link">stats::optim()</a></code> is sometimes unreliable. A more reliable but slower convergence diagnostic is to look at projection plots. The process is facilitated with the use of the R package <a href="https://CRAN.R-project.org/package=optimCheck" class="external-link"><strong>optimCheck</strong></a>.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">optimCheck</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/optimCheck/man/optim_proj.html" class="external-link">optim_proj</a></span><span class="op">(</span>fun <span class="op">=</span> <span class="va">mod</span><span class="op">$</span><span class="va">nlp</span>, <span class="co"># function to minimize</span></span>
<span>                       xsol <span class="op">=</span> <span class="va">psi_hat</span>, <span class="co"># candidate for local minimum</span></span>
<span>                       xnames <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">alpha</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">tau</span><span class="op">)</span><span class="op">)</span>, <span class="co"># parameter names</span></span>
<span>                       maximum <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="co"># check minimum not maximum</span></span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:jfsproj"></span>
<img src="subdiff_files/figure-html/jfsproj-1.png" alt="Projection plots for profile likelihood maximization.  Red lines correspond to values of the candidate solution."><p class="caption">
Figure 6: Projection plots for profile likelihood maximization. Red lines correspond to values of the candidate solution.
</p>
</div>
<p>The red lines in Figure <a href="#fig:jfsproj">6</a> correspond to the values of the candidate solution <span class="math inline">\(\boldsymbol{\psi}\)</span>. The fact that each of these values is at the minimum of the projection plot of the corresponding negative profile loglikelihood function indicates that <code><a href="https://rdrr.io/r/stats/optim.html" class="external-link">stats::optim()</a></code> has found a local optimum. We can now convert <span class="math inline">\(\hat{\boldsymbol{\psi}}\)</span> into the MLE of <span class="math inline">\(\boldsymbol{\theta}\)</span>:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">phi_hat</span> <span class="op">&lt;-</span> <span class="va">mod</span><span class="op">$</span><span class="fu">itrans</span><span class="op">(</span>psi <span class="op">=</span> <span class="va">psi_hat</span><span class="op">)</span> <span class="co"># convert psi to inferential basis (phi)</span></span>
<span><span class="va">nu_hat</span> <span class="op">&lt;-</span> <span class="va">mod</span><span class="op">$</span><span class="fu">nu_hat</span><span class="op">(</span>phi <span class="op">=</span> <span class="va">phi_hat</span><span class="op">)</span> <span class="co"># calculate nu_hat = (mu_hat, Sigma_hat)</span></span>
<span><span class="va">theta_hat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>phi <span class="op">=</span> <span class="va">phi_hat</span>, mu <span class="op">=</span> <span class="va">nu_hat</span><span class="op">$</span><span class="va">mu</span>, Sigma <span class="op">=</span> <span class="va">nu_hat</span><span class="op">$</span><span class="va">Sigma</span><span class="op">)</span></span>
<span><span class="va">theta_hat</span></span>
<span><span class="co">#&gt; $phi</span></span>
<span><span class="co">#&gt;      alpha        tau </span></span>
<span><span class="co">#&gt; 1.64196583 0.04050394 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $mu</span></span>
<span><span class="co">#&gt;             [,1]         [,2]</span></span>
<span><span class="co">#&gt; [1,] 0.004414467 0.0006510514</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $Sigma</span></span>
<span><span class="co">#&gt;              [,1]         [,2]</span></span>
<span><span class="co">#&gt; [1,] 6.951635e-04 6.862189e-06</span></span>
<span><span class="co">#&gt; [2,] 6.862189e-06 7.556147e-04</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="step-2-variance-estimation">Step 2: Variance Estimation<a class="anchor" aria-label="anchor" href="#step-2-variance-estimation"></a>
</h4>
<p>The variance of the MLE, <span class="math inline">\(\operatorname{var}(\hat{\boldsymbol{\theta}})\)</span>, is estimated by <span class="math inline">\(\boldsymbol{V}(\hat{\boldsymbol{\theta}})\)</span>, the inverse of the <a href="https://en.wikipedia.org/wiki/Observed_information" class="external-link">observed Fisher information matrix</a>,</p>
<p><span class="math display">\[
\boldsymbol{V}(\hat{\boldsymbol{\theta}}) = \left[- \frac{\partial^2}{\partial \boldsymbol{\theta}\partial \boldsymbol{\theta}'} \ell(\hat{\boldsymbol{\theta}} \mid \boldsymbol{X})\right]^{-1}.
\]</span></p>
<p>The confidence interval for a given parameter <span class="math inline">\(\theta_j\)</span> is then given by <span class="math inline">\(\hat \theta_j \pm 2 \operatorname{se}(\hat \theta_j)\)</span>, where the standard error is <span class="math inline">\(\operatorname{se}(\hat \theta_j) = \sqrt{[\boldsymbol{V}(\hat{\boldsymbol{\theta}})]_{jj}}\)</span>.</p>
<p>The <strong>subdiff</strong> package calculates the variance estimate using numerical differentiation via the R package <a href="https://CRAN.R-project.org/package=numDeriv" class="external-link"><strong>numDeriv</strong></a>. However, rather than calculating the Hessian of the loglikelihood with respect to the inferential basis <span class="math inline">\(\boldsymbol{\theta}\)</span>, <strong>subdiff</strong> instead does this with respect to a computational basis <span class="math inline">\(\boldsymbol{\omega}= (\boldsymbol{\psi}, \boldsymbol{\mu}, \boldsymbol{\lambda})\)</span>, where <span class="math inline">\(\boldsymbol{\lambda}\)</span> is the log-Cholesky decomposition of <span class="math inline">\(\boldsymbol{\Sigma}\)</span>. That is, for <span class="math inline">\(\boldsymbol{\Sigma}_{d\times d}\)</span>, <span class="math inline">\(\boldsymbol{\lambda}\)</span> is a vector of size <span class="math inline">\(d(d+1)/2\)</span> corresponding to the upper Cholesky factor of <span class="math inline">\(\boldsymbol{\Sigma}\)</span> in column-major order, but with the log of its diagonal elements. In other words, if
<span class="math display">\[
\boldsymbol{U}_{d\times d} = \begin{bmatrix}
\exp(\lambda_1) &amp; \lambda_2 &amp; \cdots &amp; \lambda_{d(d-1)/2 + 1} \\
0 &amp; \exp(\lambda_3) &amp; \cdots &amp; \lambda_{d(d-1)/2 + 2} \\
\vdots &amp; &amp; \ddots &amp; \vdots \\
0 &amp; 0 &amp; \cdots &amp; \exp(\lambda_{d(d-1)/2+d})
\end{bmatrix},
\]</span>
then <span class="math inline">\(\boldsymbol{U}\)</span> is the unique upper-triangular matrix with positive diagonal elements such that <span class="math inline">\(\boldsymbol{\Sigma}= \boldsymbol{U}'\boldsymbol{U}\)</span>. The vector <span class="math inline">\(\boldsymbol{\lambda}\)</span> is unconstrained in <span class="math inline">\(\mathbb{R}^{d(d-1)/2+d}\)</span>, and consequently <span class="math inline">\(\boldsymbol{\omega}\)</span> is unconstrained in <span class="math inline">\(\mathbb{R}^{\operatorname{dim}(\boldsymbol{\omega})}\)</span> as well, which make the numerical Hessian calculation more stable and more accurate. Moreover, the estimators <span class="math inline">\(\hat{\boldsymbol{\omega}}\)</span> and <span class="math inline">\(\boldsymbol{V}(\hat{\boldsymbol{\omega}})\)</span> can be easily used to calculate standard errors and confidence intervals for any parameter of interest as we shall see <a href="#deltamethod">below</a>.</p>
<p>The following R code shows how to calculate <span class="math inline">\(\hat{\boldsymbol{\omega}}\)</span> and <span class="math inline">\(\boldsymbol{V}(\hat{\boldsymbol{\omega}})\)</span>.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># convert theta to computational basis (omega)</span></span>
<span><span class="va">omega_hat</span> <span class="op">&lt;-</span> <span class="va">mod</span><span class="op">$</span><span class="fu">trans_full</span><span class="op">(</span>phi <span class="op">=</span> <span class="va">theta_hat</span><span class="op">$</span><span class="va">phi</span>,</span>
<span>                            mu <span class="op">=</span> <span class="va">theta_hat</span><span class="op">$</span><span class="va">mu</span>,</span>
<span>                            Sigma <span class="op">=</span> <span class="va">theta_hat</span><span class="op">$</span><span class="va">Sigma</span><span class="op">)</span></span>
<span><span class="co"># calculate fisher information matrix</span></span>
<span><span class="va">fi_obs</span> <span class="op">&lt;-</span> <span class="va">mod</span><span class="op">$</span><span class="fu">fisher</span><span class="op">(</span><span class="va">omega_hat</span><span class="op">)</span></span>
<span><span class="co"># stable inversion of fisher information</span></span>
<span><span class="va">omega_var</span> <span class="op">&lt;-</span> <span class="va">mod</span><span class="op">$</span><span class="fu">get_vcov</span><span class="op">(</span><span class="va">fi_obs</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>coef <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">signif</a></span><span class="op">(</span><span class="va">omega_hat</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>     vcov <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">signif</a></span><span class="op">(</span><span class="va">omega_var</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; $coef</span></span>
<span><span class="co">#&gt;     psi1     psi2     mu11     mu12 lambda11 lambda12 lambda22 </span></span>
<span><span class="co">#&gt;  0.50000 -3.20000  0.00440  0.00065 -3.60000  0.00026 -3.60000 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $vcov</span></span>
<span><span class="co">#&gt;              psi1     psi2     mu11     mu12 lambda11 lambda12 lambda22</span></span>
<span><span class="co">#&gt; psi1      7.3e-02  1.1e-02 -2.7e-05 -4.9e-05 -3.1e-02 -2.0e-06 -3.1e-02</span></span>
<span><span class="co">#&gt; psi2      1.1e-02  4.6e-03 -4.0e-06 -8.3e-06 -3.7e-03  2.4e-07 -3.7e-03</span></span>
<span><span class="co">#&gt; mu11     -2.7e-05 -4.0e-06  2.4e-05  2.5e-07  1.2e-05  7.6e-10  1.2e-05</span></span>
<span><span class="co">#&gt; mu12     -4.9e-05 -8.3e-06  2.5e-07  2.6e-05  2.1e-05  1.2e-09  2.0e-05</span></span>
<span><span class="co">#&gt; lambda11 -3.1e-02 -3.7e-03  1.2e-05  2.1e-05  1.4e-02  1.1e-06  1.3e-02</span></span>
<span><span class="co">#&gt; lambda12 -2.0e-06  2.4e-07  7.6e-10  1.2e-09  1.1e-06  4.2e-07  1.0e-06</span></span>
<span><span class="co">#&gt; lambda22 -3.1e-02 -3.7e-03  1.2e-05  2.0e-05  1.3e-02  1.0e-06  1.4e-02</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="deltamethod">Step 3: Estimating Arbitrary Quantities of Interest<a class="anchor" aria-label="anchor" href="#deltamethod"></a>
</h4>
<p>Let <span class="math inline">\(\boldsymbol{\psi}= (\psi_1, \ldots, \psi_P) \in \mathbb R^{P}\)</span>, for which we have the MLE <span class="math inline">\(\hat{\boldsymbol{\psi}}\)</span> and its variance estimate <span class="math inline">\(\boldsymbol{V}(\hat{\boldsymbol{\psi}})\)</span>. Now suppose we wish to estimate the quantity of interest <span class="math inline">\(\boldsymbol{\zeta}= \boldsymbol{G}(\boldsymbol{\psi}) = \big(G_1(\boldsymbol{\psi}), \ldots, G_Q(\boldsymbol{\psi})\big) \in \mathbb R^{Q}\)</span>. Then the point estimate is <span class="math inline">\(\hat{\boldsymbol{\zeta}} = \boldsymbol{G}(\hat{\boldsymbol{\psi}})\)</span>, and the corresponding variance estimate is</p>
<p><span class="math display">\[
\boldsymbol{V}(\hat{\boldsymbol{\zeta}}) = \boldsymbol{J}(\hat{\boldsymbol{\psi}})' \boldsymbol{V}(\hat{\boldsymbol{\psi}}) \boldsymbol{J}(\hat{\boldsymbol{\psi}}),
\]</span></p>
<p>where <span class="math inline">\(\boldsymbol{J}(\boldsymbol{\psi})\)</span> is the <span class="math inline">\(P \times Q\)</span> Jacobian matrix with elements <span class="math inline">\([\boldsymbol{J}(\boldsymbol{\psi})]_{ij} = \frac{\partial}{\partial \psi_i} G_j(\boldsymbol{\psi})\)</span>. The code below shows how to do this for the Jeffreys model parameters <span class="math inline">\(\boldsymbol{\zeta}= (\eta_1, \eta_2, \Gamma)\)</span> for a particle of radius <span class="math inline">\(r = 0.48 \, \mu\mathrm{m}\)</span> at temperature <span class="math inline">\(T = 298\, \mathrm{K}\)</span>. The Jacobian matrix <span class="math inline">\(\boldsymbol{J}(\hat{\boldsymbol{\psi}})\)</span> is calculated numerically using <code><a href="https://rdrr.io/pkg/numDeriv/man/jacobian.html" class="external-link">numDeriv::jacobian()</a></code>.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Calculate the Jeffreys model parameters from the parameters of the computational basis.</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @param omega Vector of computational basis parameters.</span></span>
<span><span class="co">#' @param model Jeffreys model object of class `jfs_model`.  This is used to convert `omega` to the inferential basis `theta = (phi, mu, Sigma)`.</span></span>
<span><span class="co">#' @param rad Radius of the particle (m).</span></span>
<span><span class="co">#' @param Temp Temperature of the system (Kelvin).</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' @return A vector with named elements `eta1` (N s / m^2), `eta2` (N s / m^2), and `Gamma` (kg / (m s^2)).</span></span>
<span><span class="va">jfs_zeta</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">omega</span>, <span class="va">model</span>, <span class="va">rad</span>, <span class="va">Temp</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">kB</span> <span class="op">&lt;-</span> <span class="fl">1.38064852e-23</span> <span class="co"># Boltzmann constant: m^2 kg /(s^2 K)</span></span>
<span>  <span class="co"># convert omega to theta</span></span>
<span>  <span class="va">theta</span> <span class="op">&lt;-</span> <span class="va">model</span><span class="op">$</span><span class="fu">itrans_full</span><span class="op">(</span><span class="va">omega</span><span class="op">)</span></span>
<span>  <span class="co"># parameters in simplified basis</span></span>
<span>  <span class="va">alpha</span> <span class="op">&lt;-</span> <span class="va">theta</span><span class="op">$</span><span class="va">phi</span><span class="op">[</span><span class="st">"alpha"</span><span class="op">]</span></span>
<span>  <span class="va">tau</span> <span class="op">&lt;-</span> <span class="va">theta</span><span class="op">$</span><span class="va">phi</span><span class="op">[</span><span class="st">"tau"</span><span class="op">]</span></span>
<span>  <span class="va">sigma2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">theta</span><span class="op">$</span><span class="va">Sigma</span><span class="op">)</span><span class="op">)</span> <span class="op">*</span> <span class="fl">1e-12</span> <span class="co"># convert from micron^2 to m^2</span></span>
<span>  <span class="co"># parameters in original basis</span></span>
<span>  <span class="va">eta1</span> <span class="op">&lt;-</span> <span class="fl">2</span><span class="op">*</span><span class="va">kB</span><span class="op">*</span><span class="va">Temp</span> <span class="op">/</span> <span class="op">(</span><span class="fl">6</span><span class="op">*</span><span class="va">pi</span><span class="op">*</span><span class="va">rad</span> <span class="op">*</span> <span class="va">sigma2</span><span class="op">)</span></span>
<span>  <span class="va">Gamma</span> <span class="op">&lt;-</span> <span class="va">eta1</span><span class="op">/</span><span class="va">alpha</span></span>
<span>  <span class="va">eta2</span> <span class="op">&lt;-</span> <span class="va">tau</span><span class="op">*</span><span class="va">Gamma</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">eta1</span>, <span class="va">eta2</span>, <span class="va">Gamma</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"eta1"</span>, <span class="st">"eta2"</span>, <span class="st">"Gamma"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># estimate of zeta</span></span>
<span></span>
<span><span class="va">rad</span> <span class="op">&lt;-</span> <span class="fl">0.48</span> <span class="co"># particle radius (micron)</span></span>
<span><span class="va">Temp</span> <span class="op">&lt;-</span> <span class="fl">298</span> <span class="co"># temperature of the system (Kelvin)</span></span>
<span></span>
<span><span class="co"># point estimate</span></span>
<span><span class="va">zeta_hat</span> <span class="op">&lt;-</span> <span class="fu">jfs_zeta</span><span class="op">(</span>omega <span class="op">=</span> <span class="va">omega_hat</span>,</span>
<span>                     model <span class="op">=</span> <span class="va">mod</span>,</span>
<span>                     rad <span class="op">=</span> <span class="va">rad</span> <span class="op">*</span> <span class="fl">1e-6</span>, <span class="co"># micron -&gt; m</span></span>
<span>                     Temp <span class="op">=</span> <span class="va">Temp</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># variance estimate</span></span>
<span><span class="co"># jacobian is returned as a matrix of size `length(zeta) x length(omega)`</span></span>
<span><span class="va">jac</span> <span class="op">&lt;-</span> <span class="fu">numDeriv</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/numDeriv/man/jacobian.html" class="external-link">jacobian</a></span><span class="op">(</span></span>
<span>                   func <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">omega</span><span class="op">)</span> <span class="op">{</span></span>
<span>                     <span class="fu">jfs_zeta</span><span class="op">(</span><span class="va">omega</span>,</span>
<span>                              model <span class="op">=</span> <span class="va">mod</span>, rad <span class="op">=</span> <span class="va">rad</span><span class="op">*</span><span class="fl">1e-6</span>, Temp <span class="op">=</span> <span class="va">Temp</span><span class="op">)</span></span>
<span>                   <span class="op">}</span>,</span>
<span>                   x <span class="op">=</span> <span class="va">omega_hat</span></span>
<span>                 <span class="op">)</span></span>
<span><span class="va">zeta_var</span> <span class="op">&lt;-</span> <span class="va">jac</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">omega_var</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">jac</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">zeta_var</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">zeta_var</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">zeta_hat</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>coef <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">signif</a></span><span class="op">(</span><span class="va">zeta_hat</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>     vcov <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">signif</a></span><span class="op">(</span><span class="va">zeta_var</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; $coef</span></span>
<span><span class="co">#&gt;  eta1  eta2 Gamma </span></span>
<span><span class="co">#&gt; 1.300 0.031 0.760 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $vcov</span></span>
<span><span class="co">#&gt;           eta1     eta2    Gamma</span></span>
<span><span class="co">#&gt; eta1   8.5e-02 -7.7e-06 -7.3e-03</span></span>
<span><span class="co">#&gt; eta2  -7.7e-06  8.7e-07 -2.0e-06</span></span>
<span><span class="co">#&gt; Gamma -7.3e-03 -2.0e-06  2.0e-03</span></span></code></pre></div>
<p>Finally we can convert the variance matrix estimate to standard errors and 95% confidence intervals for each element of <span class="math inline">\(\boldsymbol{\zeta}\)</span>.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># standard errors</span></span>
<span><span class="va">zeta_se</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">zeta_var</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># display point estimate, standard error, and confidence interval</span></span>
<span><span class="va">disp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span>est <span class="op">=</span> <span class="va">zeta_hat</span>,</span>
<span>              se <span class="op">=</span> <span class="va">zeta_se</span>,</span>
<span>              `2.5%` <span class="op">=</span> <span class="va">zeta_hat</span> <span class="op">-</span> <span class="fl">2</span><span class="op">*</span><span class="va">zeta_se</span>,</span>
<span>              `97.5%` <span class="op">=</span> <span class="va">zeta_hat</span> <span class="op">+</span> <span class="fl">2</span><span class="op">*</span><span class="va">zeta_se</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">signif</a></span><span class="op">(</span><span class="va">disp</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#&gt;         est      se  2.5% 97.5%</span></span>
<span><span class="co">#&gt; eta1  1.300 0.29000 0.670 1.800</span></span>
<span><span class="co">#&gt; eta2  0.031 0.00093 0.029 0.033</span></span>
<span><span class="co">#&gt; Gamma 0.760 0.04500 0.670 0.850</span></span></code></pre></div>
</div>
</div>
</div>
<div class="section level2">
<h2 id="appendix-code-for-figure-reffigfsdvsfma">Appendix: Code for Figure <a href="#fig:fsdvsfma">4</a><a class="anchor" aria-label="anchor" href="#appendix-code-for-figure-reffigfsdvsfma"></a>
</h2>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># fbm parameters</span></span>
<span><span class="va">alpha</span> <span class="op">&lt;-</span> <span class="fl">.8</span></span>
<span><span class="va">D</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span></span>
<span><span class="co"># fsd: static error parameters</span></span>
<span><span class="va">snr_seq</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">.25</span>, <span class="fl">.5</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">5</span><span class="op">)</span></span>
<span><span class="co"># fsd: dynamic error parameters (as a proportion of dt)</span></span>
<span><span class="va">ptau_seq</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">.2</span>, <span class="fl">.5</span>, <span class="fl">.9</span>, <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># fma model parameters</span></span>
<span><span class="va">rho_seq</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="op">-</span><span class="fl">.8</span>, <span class="op">-</span><span class="fl">.6</span>, <span class="op">-</span><span class="fl">.4</span>, <span class="op">-</span><span class="fl">.2</span>, <span class="fl">0</span>, <span class="fl">0.1</span>, <span class="fl">.2</span>, <span class="fl">.3</span>, <span class="fl">.5</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># msd timescale</span></span>
<span><span class="va">dt</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="fl">60</span></span>
<span><span class="va">N</span> <span class="op">&lt;-</span> <span class="fl">60</span> <span class="co"># one second of data</span></span>
<span><span class="va">tseq</span> <span class="op">&lt;-</span> <span class="va">dt</span> <span class="op">*</span> <span class="fl">1</span><span class="op">:</span><span class="va">N</span> <span class="co"># time sequence</span></span>
<span></span>
<span><span class="co">#--- msd calculations ----------------------------------------------------------</span></span>
<span></span>
<span><span class="va">fma_msd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">rho_seq</span>, <span class="kw">function</span><span class="op">(</span><span class="va">rho</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">acf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/farma_acf.html">farma_acf</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="va">alpha</span>, rho <span class="op">=</span> <span class="va">rho</span>, dt <span class="op">=</span> <span class="va">dt</span>, N <span class="op">=</span> <span class="va">N</span><span class="op">)</span></span>
<span>  <span class="fu">SuperGauss</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/SuperGauss/man/acf2msd.html" class="external-link">acf2msd</a></span><span class="op">(</span><span class="va">acf</span><span class="op">)</span> <span class="co"># convert acf to msd</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">fma_msd</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">rho_seq</span> <span class="op">!=</span> <span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"rho == "</span>, <span class="va">rho_seq</span><span class="op">)</span>, <span class="st">'"fBM"'</span><span class="op">)</span></span>
<span></span>
<span><span class="va">stat_msd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">snr_seq</span>, <span class="kw">function</span><span class="op">(</span><span class="va">snr</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">sigma2</span> <span class="op">&lt;-</span> <span class="va">dt</span><span class="op">^</span><span class="va">alpha</span><span class="op">/</span><span class="va">snr</span> <span class="co"># static error variance</span></span>
<span>  <span class="va">acf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fsd_acf.html">fsd_acf</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="va">alpha</span>, tau <span class="op">=</span> <span class="fl">0</span>, sigma2 <span class="op">=</span> <span class="va">sigma2</span>, dt <span class="op">=</span> <span class="va">dt</span>, N <span class="op">=</span> <span class="va">N</span><span class="op">)</span></span>
<span>  <span class="fu">SuperGauss</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/SuperGauss/man/acf2msd.html" class="external-link">acf2msd</a></span><span class="op">(</span><span class="va">acf</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">stat_msd</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">'"SNR" == '</span>, <span class="va">snr_seq</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dyn_msd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">ptau_seq</span>, <span class="kw">function</span><span class="op">(</span><span class="va">ptau</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># ptau is called tau in fsd_acf</span></span>
<span>  <span class="va">acf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fsd_acf.html">fsd_acf</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="va">alpha</span>, tau <span class="op">=</span> <span class="va">ptau</span>, sigma2 <span class="op">=</span> <span class="fl">0</span>, dt <span class="op">=</span> <span class="va">dt</span>, N <span class="op">=</span> <span class="va">N</span><span class="op">)</span></span>
<span>  <span class="fu">SuperGauss</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/SuperGauss/man/acf2msd.html" class="external-link">acf2msd</a></span><span class="op">(</span><span class="va">acf</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">dyn_msd</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"tau == "</span>, <span class="va">ptau_seq</span>, <span class="st">"*Delta*t"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">dyn_msd</span><span class="op">)</span><span class="op">[</span><span class="va">ptau_seq</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">'"fBM"'</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">dyn_msd</span><span class="op">)</span><span class="op">[</span><span class="va">ptau_seq</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"tau == Delta*t"</span></span>
<span></span>
<span><span class="co">#--- plot ----------------------------------------------------------------------</span></span>
<span></span>
<span><span class="co">#' Plot MSDs.</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @param data Tibble containing the plotting data.  Must contain variables `time`, `msd` and `par`.</span></span>
<span><span class="co">#' @param col Line color specification.</span></span>
<span><span class="co">#' @param ylim Vector of min and max values for y-limits.</span></span>
<span><span class="va">plot_msd</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">col</span>, <span class="va">ylim</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">time</span>, y <span class="op">=</span> <span class="va">msd</span>, group <span class="op">=</span> <span class="va">par</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="va">par</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_log10</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_log10</a></span><span class="op">(</span>limits <span class="op">=</span> <span class="va">ylim</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>label <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">breaks</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/parse.html" class="external-link">parse</a></span><span class="op">(</span>text <span class="op">=</span> <span class="va">breaks</span><span class="op">)</span>,</span>
<span>                       values <span class="op">=</span> <span class="va">col</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="st">"Time (s)"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="st">"MSD "</span><span class="op">*</span><span class="op">(</span><span class="va">mu</span><span class="op">*</span><span class="va">m</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span></span>
<span>      color <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html" class="external-link">guide_legend</a></span><span class="op">(</span></span>
<span>        title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        ncol <span class="op">=</span> <span class="fl">2</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>      legend.position <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">.95</span>, <span class="fl">.05</span><span class="op">)</span>,</span>
<span>      legend.justification <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">0</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">ylim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">.01</span>, <span class="fl">1</span><span class="op">)</span> <span class="co"># common y-limits</span></span>
<span></span>
<span><span class="co"># fma plot</span></span>
<span><span class="va">clrs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/grDevices/colorRamp.html" class="external-link">colorRampPalette</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"red"</span>, <span class="st">"orange"</span><span class="op">)</span><span class="op">)</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">rho_seq</span> <span class="op">&lt;</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="st">"black"</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/grDevices/colorRamp.html" class="external-link">colorRampPalette</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"purple"</span>, <span class="st">"blue"</span><span class="op">)</span><span class="op">)</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">rho_seq</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">fma_plt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="va">fma_msd</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>time <span class="op">=</span> <span class="va">tseq</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="op">!</span><span class="va">time</span>, names_to <span class="op">=</span> <span class="st">"par"</span>, values_to <span class="op">=</span> <span class="st">"msd"</span>,</span>
<span>               names_ptypes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>par <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">plot_msd</span><span class="op">(</span>col <span class="op">=</span> <span class="va">clrs</span>, ylim <span class="op">=</span> <span class="va">ylim</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># fsd plot</span></span>
<span><span class="va">clrs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/grDevices/colorRamp.html" class="external-link">colorRampPalette</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"red"</span>, <span class="st">"orange"</span><span class="op">)</span><span class="op">)</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">snr_seq</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="st">"black"</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/grDevices/colorRamp.html" class="external-link">colorRampPalette</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"purple"</span>, <span class="st">"blue"</span><span class="op">)</span><span class="op">)</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">ptau_seq</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">fsd_plt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">stat_msd</span>, <span class="va">dyn_msd</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>time <span class="op">=</span> <span class="va">tseq</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="op">!</span><span class="va">time</span>, names_to <span class="op">=</span> <span class="st">"par"</span>, values_to <span class="op">=</span> <span class="st">"msd"</span>,</span>
<span>               names_ptypes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>par <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">plot_msd</span><span class="op">(</span>col <span class="op">=</span> <span class="va">clrs</span>, ylim <span class="op">=</span> <span class="va">ylim</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># combine the two</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/gridExtra/man/arrangeGrob.html" class="external-link">grid.arrange</a></span><span class="op">(</span></span>
<span>  <span class="va">fsd_plt</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"(a) fSD Model"</span><span class="op">)</span>,</span>
<span>  <span class="va">fma_plt</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"(b) fMA Model"</span><span class="op">)</span>,</span>
<span>  ncol <span class="op">=</span> <span class="fl">2</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-hill.etal14" class="csl-entry">
Hill, D. B., Vasquez, P. A., Mellnik, J., McKinley, S. A., Vose, A., Mu, F., Henderson, A. G., Donaldson, S. H., Alexis, N. E., Boucher, R. C., and Forest, M. G. (2014), <span>“A biophysical basis for mucus solids concentration as a candidate biomarker for airways disease,”</span> <em>PloS one</em>, Public Library of Science, 9, e87681.
</div>
<div id="ref-ling.lysy20" class="csl-entry">
Ling, Y., and Lysy, M. (2020), <span>“<a href="https://github.com/mlysy/SuperGauss/blob/master/doc/SuperGauss_preprint.pdf" class="external-link">Superfast inference of stationary <span>Gaussian</span> time series</a>,”</span> <em>Preprint</em>.
</div>
<div id="ref-ling.etal19" class="csl-entry">
Ling, Y., Lysy, M., Seim, I., Newby, J. M., Hill, D. B., Cribb, J., and Forest, M. G. (2022), <span>“<a href="https://arxiv.org/abs/1911.06451" class="external-link">Measurement error correction in particle tracking microrheology</a>,”</span> <em>AOAS (forthcoming)</em>.
</div>
<div id="ref-lysy.etal16" class="csl-entry">
Lysy, M., Pillai, N. S., Hill, D. B., Forest, M. G., Mellnik, J. W., Vasquez, P. A., and McKinley, S. A. (2016), <span>“Model comparison and assessment for single particle tracking in biological fluids,”</span> <em>Journal of the American Statistical Association</em>, Taylor &amp; Francis, 111, 1413–1426.
</div>
<div id="ref-raikher.rusakov10" class="csl-entry">
Raikher, Y. L., and Rusakov, V. (2010), <span>“Theory of <span>Brownian</span> motion in a <span>Jeffreys</span> fluid,”</span> <em>Journal of Experimental and Theoretical Physics</em>, Springer, 111, 883–889.
</div>
<div id="ref-savin.doyle05" class="csl-entry">
Savin, T., and Doyle, P. S. (2005), <span>“Static and dynamic errors in particle tracking microrheology,”</span> <em>Biophysical Journal</em>, Elsevier, 88, 623–638.
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><!-- load mathjax after it has been configured --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><div class="copyright">
  <!-- <p>Copyright 2017-2019 Martin Lysy</p> -->
  <script>
    function get_date() {
	// return "aaaa";
	var x = new Date(Date.parse(document.lastModified));
	var d = x.getDate();
	var m = x.getMonth() + 1;
	var y = x.getYear();
	// different on IE and NS
	if(y >= 2000)
	{
	    y -= 2000;
	}
	if(y >= 100)
	{
	    y -= 100;
	}
	y = y + 2000;
	// x = new Date(x);
	// return x.getMonth();
	return "" + m + "/" + d + "/" + y;
    }
  </script><p>Last updated: <script> document.write(get_date()) </script></p>


      
   </div>






  </footer>
</div>
</body>
</html>
